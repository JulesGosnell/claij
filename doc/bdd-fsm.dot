digraph "bdd" {
  rankdir=TB;
  node [shape=box, style=rounded, fontname="Helvetica", fontsize=10];
  edge [fontname="Helvetica", fontsize=9];
  
  // Title
  title [shape=plaintext label=<<FONT POINT-SIZE="14" COLOR="gray40">Bath Driven Development FSM</FONT>>];
  { rank=same title }
  title -> "start" [style=invis];
  
  // Terminal states
  "start" [shape=doublecircle, fillcolor=lightgreen, style=filled];
  "end"   [shape=doublecircle, fillcolor=lightcoral, style=filled];

  // Main states
  "stt" [label="stt\n(openapi-call)\nSpeech to Text"];
  "llm" [label="llm\n(llm + mcp hat)\nLarge Language Model\nGitHub + Clojure tools"];
  "tts" [label="tts\n(openapi-call)\nText to Speech"];

  // Hat-generated cluster
  subgraph cluster_llm_hat {
    label="Hat-generated";
    style=dashed;
    color=gray60;
    fontcolor=gray40;
    
    "llm-mcp" [label="llm-mcp\n(mcp-service)\nExecutes tool calls" style="rounded,dashed"];
  }

  // Main flow transitions
  "start" -> "stt" [label="audio in"];
  "stt" -> "llm" [label="transcribed"];
  "llm" -> "tts" [label="response"];
  "tts" -> "end" [label="audio out"];
  
  // Hat transitions (dashed)
  "llm" -> "llm-mcp" [label="tool calls" style=dashed];
  "llm-mcp" -> "llm" [label="tool results" style=dashed];
}
